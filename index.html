<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mission Control x Pathway Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #66eaa4 0%, #217942 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .header h1 { color: #4a5568; font-size: 2.5rem; margin-bottom: 10px; }
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .tab-button {
            flex: 1; padding: 15px 20px; background: none; border: none;
            border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 600;
            transition: all 0.3s ease; color: #4a5568;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #66ea8e 0%, #368e4f 100%);
            color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .tab-content {
            display: none; background: rgba(255, 255, 255, 0.95);
            border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 20px; }
        .form-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        input, select, textarea {
            width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0;
            border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: white;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #206d26; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .new-item-inline {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: #f0fdf4;
            border: 2px dashed #34d399;
            border-radius: 10px;
        }
        .new-item-inline.active { display: block; }
        .new-item-inline input {
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #66ea8e 0%, #368e4f 100%);
            color: white; border: none; padding: 15px 30px; border-radius: 10px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        }

        .search-container { display: flex; gap: 18px; margin-bottom: 34px; align-items: end; flex-wrap: wrap; }
        .search-container > div { flex: 1; min-width: 180px; }

        .data-table { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; font-size: 0.9rem; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid #eef3f6; white-space: nowrap; }
        th { background: linear-gradient(135deg, #66ea8e 0%, #368e4f 100%); color: white; font-weight: 600; font-size: 0.85rem; }
        tbody tr:hover { background-color: #f8fafc; }
        
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; text-align: center; display:inline-block; }
        .status-open { background: #c6f6d5; color: #22543d; }
        .status-customization { background: #fef3c7; color: #92400e; }
        .status-playback, .status-qa { background: #dbeafe; color: #1e40af; }
        .status-ready-for-delivery { background: #c6f6d5; color: #22543d; }
        .status-close { background: #fed7d7; color: #742a2a; }
        .row-red { background-color: #fee2e2 !important; }
        .row-yellow { background-color: #fef3c7 !important; }
        .row-green { background-color: #d1fae5 !important; }
        .warning-box { background: #fef3c7; border: 2px solid #f59e0b; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px; }

        .loading { text-align: center; padding: 40px; color: #4a5568; }
        .message { padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: 600; }
        .message.success { background: #c6f6d5; color: #22543d; }
        .message.error { background: #fed7d7; color: #742a2a; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #368e4f; }
        .stat-label { color: #718096; margin-top: 5px; }

        .global-loader {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.35); z-index: 9999;
        }
        .global-loader.hidden { display: none; }
        .loader-box {
            background: #fff; padding: 16px 20px; border-radius: 12px; display: flex;
            gap: 12px; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        }
        .spinner {
            width: 28px; height: 28px; border-radius: 50%; border: 4px solid #e6e6e6;
            border-top-color: #368e4f; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { font-weight: 700; color: #2d3748; font-size: 0.95rem; }

        .action-btn {
            padding: 6px 12px; margin: 0 4px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;
        }
        .edit-btn { background: #368e4f; color: white; }
        .edit-btn:hover { background: #2d7a42; }
        .delete-btn { background: #dc2626; color: white; }
        .delete-btn:hover { background: #b91c1c; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 15px; padding: 30px;
            max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .modal-header h3 { color: #368e4f; }
        .close-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;
        }
        .close-btn:hover { color: #368e4f; }

        .help-text {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        .filter-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            color: #368e4f;
        }

        .filter-tab.active {
            color: #368e4f;
            border-bottom-color: #368e4f;
        }

        .filter-mode-content {
            display: none;
            margin-bottom: 20px;
        }

        .filter-mode-content.active {
            display: block;
        }

        select option[value="__new__"] {
            background: #f0fdf4;
            color: #059669;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-row, .search-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Mission Control x Pathway Tracker</h1>
            <p>Version Control System</p>
        </div>

        <div id="globalLoader" class="global-loader hidden">
            <div class="loader-box">
                <div class="spinner"></div>
                <div id="globalLoaderMessage" class="loader-text">Loading...</div>
            </div>
        </div>

        <div class="tabs">
        <button class="tab-button active" onclick="showTab('dashboard')">Dashboard</button>
        <button class="tab-button" onclick="showTab('add')">Add New Entry</button>
        <button class="tab-button" onclick="showTab('view')">View & Search</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="tab-content active">
        <h2>Dashboard Overview</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalClients">-</div>
                <div class="stat-label">Total Clients</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalProgrammes">-</div>
                <div class="stat-label">Programmes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalModules">-</div>
                <div class="stat-label">Modules</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalClasses">-</div>
                <div class="stat-label">Classes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalVersions">-</div>
                <div class="stat-label">Ready for Delivery!</div>
            </div>
        </div>
    </div>

    <!-- Add New Entry -->
    <div id="add" class="tab-content">
        <h2> Add New Entry</h2>
        <p></p>
        <form id="addForm">
            <div class="form-row">
                <!-- CLIENT -->
                <div class="form-group">
                    <label>Client *</label>
                    <select id="addClient" required>
                        <option value="">Select Client</option>
                        <option value="__new__">Create New Client</option>
                    </select>
                    <div id="newClientBox" class="new-item-inline">
                        <input type="text" id="newClientName" placeholder="Client Name" />
                        <button type="button" class="btn" onclick="createNewClient()">Create Client</button>
                    </div>
                </div>

                <!-- PROGRAMME -->
                <div class="form-group">
                    <label>Programme *</label>
                    <select id="addProgramme" required disabled>
                        <option value="">Select Client First</option>
                    </select>
                    <div id="newProgrammeBox" class="new-item-inline">
                        <input type="text" id="newProgrammeName" placeholder="Programme Name" />
                        <button type="button" class="btn" onclick="createNewProgramme()">Create Programme</button>
                    </div>
                </div>

                <!-- MODULE -->
                <div class="form-group">
                    <label>Module *</label>
                    <select id="addModule" required disabled>
                        <option value="">Select Programme First</option>
                    </select>
                    <div id="newModuleBox" class="new-item-inline">
                        <input type="text" id="newModuleName" placeholder="Module Name" />
                        <input type="number" id="newModuleNumber" placeholder="Module Number (e.g., 1)" />
                        <button type="button" class="btn" onclick="createNewModule()">Create Module</button>
                    </div>
                </div>

                <!-- CLASS -->
                <div class="form-group">
                    <label>Class *</label>
                    <select id="addClass" required disabled>
                        <option value="">Select Module First</option>
                    </select>
                    <div id="newClassBox" class="new-item-inline">
                        <input type="text" id="newClassName" placeholder="Class Name" />
                        <input type="number" id="newClassNumber" placeholder="Class Number (e.g., 1)" />
                        <button type="button" class="btn" onclick="createNewClass()">Create Class</button>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Version Code (Auto-generated)</label>
                    <input type="text" id="addVersionCode" readonly style="background: #f3f4f6;" />
                    <span class="help-text">Auto-generated: CLIENT-MODULE-CLASS-v#</span>
                </div>
                <div class="form-group">
                    <label>Version Number *</label>
                    <input type="text" id="addVersionNumber" readonly value="v1.0" style="background: #f3f4f6;" />
                    <span class="help-text">Auto-increments based on existing versions</span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Content Readiness * 🚦</label>
                        <select id="addReadiness" required>
                            <option value="Not Started">🔴 Not Started</option>
                            <option value="Baseline Only">🟡 Baseline Only</option>
                            <option value="In Development">🟡 In Development</option>
                            <option value="Ready for Delivery" selected>🟢 Ready for Delivery</option>
                            <option value="Client Approved">⭐ Client Approved</option>
                        </select>
                        <span class="help-text">CS can only propose 🟢 Ready or ⭐ Approved</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Workflow Status *</label>
                        <select id="addStatus" required>
                            <option>Open</option>
                            <option>Customization</option>
                            <option>Playback</option>
                            <option>QA</option>
                            <option>Ready for Delivery</option>
                            <option>Close</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Client Feedback / Rating</label>
                    <select id="addFeedback">
                        <option value="">No feedback yet </option>
                        <option value="Excellent"> ⭐⭐⭐⭐⭐ Excellent </option>
                        <option value="Good"> ⭐⭐⭐⭐ Good </option>
                        <option value="Neutral"> ⭐⭐⭐ Neutral </option>
                        <option value="Needs Improvement"> ⭐⭐ Needs Improvement </option>
                        <option value="Poor"> ⭐ Poor - Requires Overhaul </option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Drive Link</label>
                <input type="url" id="addDriveLink" placeholder="https://drive.google.com/..." />
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea id="addNotes" rows="3" placeholder="Any additional notes..."></textarea>
            </div>

            <div id="readinessWarning" class="warning-box" style="display: none;">
                <strong style="color: #92400e;">⚠️ CONTENT READINESS WARNING</strong>
                <p style="color: #92400e; margin-top: 8px;" id="warningText"></p>
            </div>

            <button type="submit" class="btn" style="width:100%">Add Content Version</button>
        </form>
    </div>

    <!-- View & Search -->
    <div id="view" class="tab-content">
        <h2>View & Search Content Versions</h2>
        
        <!-- Filters Section -->
        <div style="margin-bottom: 30px;">
            <!-- Filter Mode Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                <button id="drillDownTab" class="filter-tab active" onclick="switchFilterMode('drillDown')">
                    🔽 Drill Down
                </button>
                <button id="quickSearchTab" class="filter-tab" onclick="switchFilterMode('quickSearch')">
                    🔍 Quick Search
                </button>
            </div>

            <!-- Drill Down Filters (Sequential) -->
            <div id="drillDownFilters" class="filter-mode-content active">
                <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 15px;">
                    Navigate step-by-step: Client → Programme → Module
                </p>
                <div class="search-container">
                    <div class="form-group">
                        <label>Client</label>
                        <select id="filterClient">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Programme</label>
                        <select id="filterProgramme" disabled>
                            <option value="">Select client first</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Module</label>
                        <select id="filterModule" disabled>
                            <option value="">Select programme first</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Quick Search Filters (Independent) -->
            <div id="quickSearchFilters" class="filter-mode-content">
                <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 15px;">
                    Search directly by any criteria - all filters are independent
                </p>
                <div class="search-container">
                    <div class="form-group">
                        <label>Programme</label>
                        <select id="quickSearchProgramme">
                            <option value="">All Programmes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Module</label>
                        <select id="quickSearchModule">
                            <option value="">All Modules</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Readiness 🚦</label>
                        <select id="filterReadiness">
                            <option value="">All</option>
                            <option value="Not Started">🔴 Not Started</option>
                            <option value="Baseline Only">🟡 Baseline</option>
                            <option value="In Development">🟡 Dev</option>
                            <option value="Ready for Delivery">🟢 Ready</option>
                            <option value="Client Approved">⭐ Approved</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="filterStatus">
                            <option value="">All Statuses</option>
                            <option>Open</option>
                            <option>Customization</option>
                            <option>Playback</option>
                            <option>QA</option>
                            <option>Ready for Delivery</option>
                            <option>Close</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Apply/Clear Buttons -->
            <div style="margin-top: 20px;">
                <button class="btn" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
            </div>
        </div>

        <!-- Results Section (Full Width) -->
        <div style="clear: both; width: 100%;">
            <!-- Warning Box (shown after filtering) -->
            <div id="readinessWarning" class="warning-box" style="display: none;"></div>

            <div id="resultsCount" style="margin: 20px 0 15px 0; color: #64748b; font-weight: 600;"></div>
            <div id="dataContainer" class="loading">Select filters and click "Apply Filters"</div>
        </div>
    </div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Content Version</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalMessage"></div>
        <form id="editForm">
            <input type="hidden" id="editVersionId">
            <div class="form-group">
                <label>Version Code</label>
                <input type="text" id="editVersionCode" readonly style="background: #f3f4f6;">
            </div>
            <div class="form-group">
                <label>Version Number (Auto-calculated)</label>
                <input type="text" id="editVersionNumber" readonly style="background: #f3f4f6;">
                <span class="help-text">
                    ℹ️ Version only increments if you add a changelog entry below (content changed)
                </span>
            </div>

            <div class="form-group">
                <label>Content Readiness 🚦</label>
                <select id="editReadiness">
                    <option value="Not Started">🔴 Not Started</option>
                    <option value="Baseline Only">🟡 Baseline</option>
                    <option value="In Development">🟡 In Development</option>
                    <option value="Ready for Delivery">🟢 Ready</option>
                    <option value="Client Approved">⭐ Approved</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="editStatus">
                    <option>Open</option>
                    <option>Customization</option>
                    <option>Playback</option>
                    <option>QA</option>
                    <option>Ready for Delivery</option>
                    <option>Close</option>
                </select>
            </div>
            <div class="form-group">
                <label>Client Feedback</label>
                <select id="editFeedback">
                    <option value="">No feedback</option>
                    <option value="Excellent">⭐⭐⭐⭐⭐ Excellent</option>
                    <option value="Good">⭐⭐⭐⭐ Good</option>
                    <option value="Neutral">⭐⭐⭐ Neutral</option>
                    <option value="Needs Improvement">⭐⭐ Needs Improvement</option>
                    <option value="Poor">⭐ Poor</option>
                </select>
            </div>
            <div class="form-group">
                <label>What Changed? (Changelog)</label>
                <textarea id="editChangeSummary" rows="3" placeholder="e.g., Updated slides 5-7, Rewrote section 2, Added new examples" oninput="updateVersionPreview()"></textarea>
                <span class="help-text">
                    💡 Only fill this out if content actually changed. Leave blank for metadata updates (feedback, status, etc.)
                </span>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="editSignificantChange" onchange="updateVersionPreview()">
                    <label for="editSignificantChange" style="margin: 0;">🚨 Significant change</label>
                </div>
                <span class="help-text" style="margin-top: 8px; display: block;">
                    ☐ Unchecked = Minor update (v1.0 → v1.1) | ☑ Checked = Major overhaul (v1.x → v2.0)
                </span>
            </div>

            <div class="form-group">
                <label>Drive Link</label>
                <input type="url" id="editDriveLink">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="editNotes" rows="4"></textarea>
            </div>
            <button type="submit" class="btn" style="width: 100%;">Save Changes</button>
        </form>
    </div>
</div>

<!-- History Modal -->
<div class="modal" id="historyModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>📜 Version History</h3>
            <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
        </div>
        <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
            <p style="text-align: center; color: #64748b;">Loading history...</p>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sxhgkbqgzydugvbqvotz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4aGdrYnFnenlkdWd2YnF2b3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyODAyODcsImV4cCI6MjA3NTg1NjI4N30.PtgtqjKHI_QcAglp2wmb-UgY4Raa9ULYKnCjpiwLmG4';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allData = [];
    let currentFilters = { 
        client: null, 
        programme: null, 
        module: null, 
        status: null, 
        readiness: null,
        quickProgramme: null,
        quickModule: null
    };
    
    // Track newly created IDs during form flow
    let formState = {
        clientId: null,
        programmeId: null,
        moduleId: null,
        classId: null
    };

    function showGlobalLoading(msg = 'Loading...') {
        document.getElementById('globalLoaderMessage').textContent = msg;
        document.getElementById('globalLoader').classList.remove('hidden');
    }

    function hideGlobalLoading() {
        document.getElementById('globalLoader').classList.add('hidden');
    }

    function switchFilterMode(mode) {
        // Update tab buttons
        document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.filter-mode-content').forEach(content => content.classList.remove('active'));
        
        if (mode === 'drillDown') {
            document.getElementById('drillDownTab').classList.add('active');
            document.getElementById('drillDownFilters').classList.add('active');
        } else {
            document.getElementById('quickSearchTab').classList.add('active');
            document.getElementById('quickSearchFilters').classList.add('active');
        }
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        const content = document.getElementById(tabName); if (content) content.classList.add('active');
        // add active class to clicked button
        if (event?.target) {
            // if user clicked an inner element (like an icon), walk up to the button
            const btn = event.target.closest('.tab-button');
            if (btn) btn.classList.add('active');
        }

        // run any tab-specific setup
        if (tabName === 'dashboard') loadDashboard();
        if (tabName === 'add') setupAddForm();

        event.target.classList.add('active');
        if (tabName === 'dashboard') loadDashboard();
        if (tabName === 'add') setupAddForm();
    }

    function showMessage(elementId, message, type = 'success') {
        const el = document.getElementById(elementId);
        el.innerHTML = `<div class="message ${type}">${message}</div>`;
        setTimeout(() => el.innerHTML = '', 5000);
    }

    async function loadDashboard() {
        showGlobalLoading('Loading dashboard...');
        try {
            const [clients, programmes, modules, classes, versions] = await Promise.all([
                supabase.from('clients').select('*'),
                supabase.from('programmes').select('*'),
                supabase.from('modules').select('*'),
                supabase.from('classes').select('*'),
                supabase.from('content_versions').select('*')
            ]);

            document.getElementById('totalClients').textContent = clients.data?.length || 0;
            document.getElementById('totalProgrammes').textContent = programmes.data?.length || 0;
            document.getElementById('totalModules').textContent = modules.data?.length || 0;
            document.getElementById('totalClasses').textContent = classes.data?.length || 0;
            
            // Count only content that's ready for delivery or client approved
            const readyCount = versions.data?.filter(v => 
                v.readiness_level === 'Ready for Delivery' || 
                v.readiness_level === 'Client Approved'
            ).length || 0;
            document.getElementById('totalVersions').textContent = readyCount;

            await populateFilterDropdowns();
            await loadAllData();
        } finally {
            hideGlobalLoading();
        }
    }

    async function populateFilterDropdowns() {
        // Load clients for drill-down filter
        const { data: clients } = await supabase.from('clients').select('*').order('client_name');
        const clientSel = document.getElementById('filterClient');
        clientSel.innerHTML = '<option value="">All Clients</option>';
        clients?.forEach(c => {
            clientSel.innerHTML += `<option value="${c.client_id}">${c.client_name}</option>`;
        });

        // Load ALL programmes for quick search
        const { data: programmes } = await supabase.from('programmes').select('*').order('programme_name');
        const quickProgSel = document.getElementById('quickSearchProgramme');
        quickProgSel.innerHTML = '<option value="">All Programmes</option>';
        programmes?.forEach(p => {
            quickProgSel.innerHTML += `<option value="${p.programme_id}">${p.programme_name}</option>`;
        });

        // Load ALL modules for quick search
        const { data: modules } = await supabase
            .from('modules')
            .select('module_id, module_name, module_number, programmes(programme_name)')
            .order('module_name');
        const quickModSel = document.getElementById('quickSearchModule');
        quickModSel.innerHTML = '<option value="">All Modules</option>';
        modules?.forEach(m => {
            const progName = m.programmes?.programme_name || '';
            quickModSel.innerHTML += `<option value="${m.module_id}">${m.module_name}${progName ? ' (' + progName + ')' : ''}</option>`;
        });
    }

    async function setupAddForm() {
        // Load clients
        const { data: clients } = await supabase.from('clients').select('*').order('client_name');
        const clientSel = document.getElementById('addClient');
        clientSel.innerHTML = '<option value="">Select Client</option>';
        clients?.forEach(c => {
            clientSel.innerHTML += `<option value="${c.client_id}">${c.client_name}</option>`;
        });
        clientSel.innerHTML += '<option value="__new__">Create New Client</option>';

        // Readiness warning handler
        document.getElementById('addReadiness').onchange = (e) => {
            const readiness = e.target.value;
            const warningBox = document.getElementById('readinessWarning');
            const warningText = document.getElementById('warningText');
            if (readiness === 'Not Started' || readiness === 'Baseline Only' || readiness === 'In Development') {
                warningBox.style.display = 'block';
                warningText.textContent = `This content is marked as "${readiness}". CS should NOT propose this to clients without Education team approval.`;
            } else {
                warningBox.style.display = 'none';
            }
        };

        // Client change handler
        clientSel.onchange = async (e) => {
            const val = e.target.value;
            const progSel = document.getElementById('addProgramme');
            const newBox = document.getElementById('newClientBox');
            
            // Show/hide new client box
            newBox.classList.toggle('active', val === '__new__');
            
            if (val && val !== '__new__') {
                formState.clientId = val;
                
                // Load programmes for this client
                const { data } = await supabase
                    .from('client_pathways')
                    .select('programme_id, programmes(programme_id, programme_name)')
                    .eq('client_id', val);
                
                progSel.innerHTML = '<option value="">Select Programme</option>';
                data?.forEach(p => {
                    if (p.programmes) {
                        progSel.innerHTML += `<option value="${p.programmes.programme_id}">${p.programmes.programme_name}</option>`;
                    }
                });
                progSel.innerHTML += '<option value="__new__">Create New Programme</option>';
                progSel.disabled = false;
            } else {
                progSel.disabled = true;
                progSel.innerHTML = '<option value="">Select Client First</option>';
            }
            
            // Reset downstream
            document.getElementById('addModule').disabled = true;
            document.getElementById('addClass').disabled = true;
            generateVersionCode();
        };

        // Programme change handler
        document.getElementById('addProgramme').onchange = async (e) => {
            const val = e.target.value;
            const modSel = document.getElementById('addModule');
            const newBox = document.getElementById('newProgrammeBox');
            
            newBox.classList.toggle('active', val === '__new__');
            
            if (val && val !== '__new__') {
                formState.programmeId = val;
                
                const { data } = await supabase
                    .from('modules')
                    .select('*')
                    .eq('programme_id', val)
                    .order('module_number');
                
                modSel.innerHTML = '<option value="">Select Module</option>';
                data?.forEach(m => {
                    modSel.innerHTML += `<option value="${m.module_id}">${m.module_name}</option>`;
                });
                modSel.innerHTML += '<option value="__new__">Create New Module</option>';
                modSel.disabled = false;
            } else {
                modSel.disabled = true;
                modSel.innerHTML = '<option value="">Select Programme First</option>';
            }
            
            document.getElementById('addClass').disabled = true;
            generateVersionCode();
        };

        // Module change handler
        document.getElementById('addModule').onchange = async (e) => {
            const val = e.target.value;
            const clsSel = document.getElementById('addClass');
            const newBox = document.getElementById('newModuleBox');
            
            newBox.classList.toggle('active', val === '__new__');
            
            if (val && val !== '__new__') {
                formState.moduleId = val;
                
                const { data } = await supabase
                    .from('classes')
                    .select('*')
                    .eq('module_id', val)
                    .order('class_number');
                
                clsSel.innerHTML = '<option value="">Select Class</option>';
                data?.forEach(c => {
                    clsSel.innerHTML += `<option value="${c.class_id}">${c.class_name}</option>`;
                });
                clsSel.innerHTML += '<option value="__new__">Create New Class</option>';
                clsSel.disabled = false;
            } else {
                clsSel.disabled = true;
                clsSel.innerHTML = '<option value="">Select Module First</option>';
            }
            generateVersionCode();
        };

        // Class change handler
        document.getElementById('addClass').onchange = (e) => {
            const val = e.target.value;
            const newBox = document.getElementById('newClassBox');
            newBox.classList.toggle('active', val === '__new__');
            
            if (val && val !== '__new__') {
                formState.classId = val;
            }
            generateVersionCode();
        };

        // Form submit
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            
            if (!formState.classId || !formState.clientId || !formState.programmeId) {
                showMessage('addMessage', 'Please complete all required fields', 'error');
                return;
            }

            showGlobalLoading('Creating content version...');
            
            try {
                // Ensure client_pathway exists
                let { data: pathway } = await supabase
                    .from('client_pathways')
                    .select('pathway_id')
                    .eq('client_id', formState.clientId)
                    .eq('programme_id', formState.programmeId)
                    .maybeSingle();
                
                if (!pathway) {
                    const { data: newPathway, error: pathError } = await supabase
                        .from('client_pathways')
                        .insert({
                            client_id: formState.clientId,
                            programme_id: formState.programmeId,
                            cohort_name: 'Default',
                            status: 'Active'
                        })
                        .select()
                        .single();
                    
                    if (pathError) throw pathError;
                    pathway = newPathway;
                }

                const readiness = document.getElementById('addReadiness').value;
                // Warning confirmation for incomplete content
                if (readiness === 'Not Started' || readiness === 'Baseline Only' || readiness === 'In Development') {
                    const confirmed = confirm(
                        `⚠️ CONTENT READINESS WARNING\n\n` +
                        `This content is marked as "${readiness}".\n\n` +
                        `Click OK to proceed, or Cancel to review.`
                    );
                    if (!confirmed) {
                        hideGlobalLoading();
                        return;
                    }
                }

                const { error } = await supabase.from('content_versions').insert({
                    class_id: formState.classId,
                    pathway_id: pathway.pathway_id,
                    version_code: document.getElementById('addVersionCode').value,
                    version_number: document.getElementById('addVersionNumber').value,
                    status: document.getElementById('addStatus').value,
                    readiness_level: readiness,
                    client_feedback: document.getElementById('addFeedback').value || null,
                    drive_link: document.getElementById('addDriveLink').value || null,
                    notes: document.getElementById('addNotes').value || null,
                    created_by: 'Dashboard User'
                });

                if (error) throw error;

                showMessage('addMessage', 'Content version created successfully!', 'success');
                document.getElementById('addForm').reset();
                formState = { clientId: null, programmeId: null, moduleId: null, classId: null };
                await loadAllData();
                
                // Reset form
                document.getElementById('addProgramme').disabled = true;
                document.getElementById('addModule').disabled = true;
                document.getElementById('addClass').disabled = true;

            } catch (error) {
                showMessage('addMessage', 'Error: ' + error.message, 'error');
            } finally {
                hideGlobalLoading();
            }
        };
    }

    async function generateVersionCode() {
        const clientSel = document.getElementById('addClient');
        const moduleSel = document.getElementById('addModule');
        const classSel = document.getElementById('addClass');
        const codeInput = document.getElementById('addVersionCode');
        const versionNumInput = document.getElementById('addVersionNumber');

        const clientVal = clientSel.value;
        const moduleVal = moduleSel.value;
        const classVal = classSel.value;

        if (!clientVal || clientVal === '__new__' || 
            !moduleVal || moduleVal === '__new__' || 
            !classVal || classVal === '__new__') {
            codeInput.value = '';
            versionNumInput.value = 'v1.0';
            return;
        }

        const clientText = clientSel.options[clientSel.selectedIndex].text;
        const moduleText = moduleSel.options[moduleSel.selectedIndex].text;
        const classText = classSel.options[classSel.selectedIndex].text;

        // Get existing versions for this specific class + pathway combination
        const { data: existing } = await supabase
            .from('content_versions')
            .select('version_code, version_number, version_id')
            .eq('class_id', classVal)
            .eq('pathway_id', await getCurrentPathwayId())
            .order('created_at', { ascending: false });

        const versionCount = (existing?.length || 0) + 1;
        
        // Generate base code (without version number)
        const baseCode = `${clientText.substring(0, 3).toUpperCase()}-${
            moduleText.substring(0, 3).toUpperCase()}-${
            classText.substring(0, 3).toUpperCase()}`.replace(/\s/g, '');
        
        // Full version code with incremental version
        const fullCode = `${baseCode}-v${versionCount}`;
        
        codeInput.value = fullCode;
        versionNumInput.value = `v${versionCount}.0`;
    }

    async function getCurrentPathwayId() {
        if (!formState.clientId || !formState.programmeId) return null;
        
        const { data } = await supabase
            .from('client_pathways')
            .select('pathway_id')
            .eq('client_id', formState.clientId)
            .eq('programme_id', formState.programmeId)
            .maybeSingle();
        
        return data?.pathway_id || null;
    }

    // CREATE NEW ENTITIES
    async function createNewClient() {
        const name = document.getElementById('newClientName').value.trim();
        if (!name) {
            showMessage('addMessage', 'Please enter a client name', 'error');
            return;
        }

        showGlobalLoading('Creating client...');
        try {
            const { data, error } = await supabase
                .from('clients')
                .insert({ client_name: name })
                .select()
                .single();

            if (error) throw error;

            // Add to dropdown and select it
            const sel = document.getElementById('addClient');
            const newOpt = document.createElement('option');
            newOpt.value = data.client_id;
            newOpt.textContent = data.client_name;
            sel.insertBefore(newOpt, sel.querySelector('option[value="__new__"]'));
            sel.value = data.client_id;

            // Hide box and trigger change
            document.getElementById('newClientBox').classList.remove('active');
            document.getElementById('newClientName').value = '';
            sel.dispatchEvent(new Event('change'));

            showMessage('addMessage', 'Client created!', 'success');
        } catch (error) {
            showMessage('addMessage', 'Error: ' + error.message, 'error');
        } finally {
            hideGlobalLoading();
        }
    }

    async function createNewProgramme() {
        const name = document.getElementById('newProgrammeName').value.trim();
        if (!name || !formState.clientId) {
            showMessage('addMessage', 'Please select a client and enter programme name', 'error');
            return;
        }

        showGlobalLoading('Creating programme...');
        try {
            // Create programme
            const { data: prog, error: progErr } = await supabase
                .from('programmes')
                .insert({ programme_name: name, programme_type: 'Standard' })
                .select()
                .single();

            if (progErr) throw progErr;

            // Create client_pathway
            const { error: pathErr } = await supabase
                .from('client_pathways')
                .insert({
                    client_id: formState.clientId,
                    programme_id: prog.programme_id,
                    cohort_name: 'Default',
                    status: 'Active'
                });

            if (pathErr) throw pathErr;

            // Add to dropdown and select it
            const sel = document.getElementById('addProgramme');
            const newOpt = document.createElement('option');
            newOpt.value = prog.programme_id;
            newOpt.textContent = prog.programme_name;
            sel.insertBefore(newOpt, sel.querySelector('option[value="__new__"]'));
            sel.value = prog.programme_id;

            // Hide box and trigger change
            document.getElementById('newProgrammeBox').classList.remove('active');
            document.getElementById('newProgrammeName').value = '';
            sel.dispatchEvent(new Event('change'));

            showMessage('addMessage', 'Programme created!', 'success');
        } catch (error) {
            showMessage('addMessage', 'Error: ' + error.message, 'error');
        } finally {
            hideGlobalLoading();
        }
    }

    async function createNewModule() {
        const name = document.getElementById('newModuleName').value.trim();
        const num = document.getElementById('newModuleNumber').value;
        if (!name || !num || !formState.programmeId) {
            showMessage('addMessage', 'Please enter all module details', 'error');
            return;
        }

        showGlobalLoading('Creating module...');
        try {
            const { data, error } = await supabase
                .from('modules')
                .insert({
                    module_name: name,
                    module_number: parseInt(num),
                    programme_id: formState.programmeId
                })
                .select()
                .single();

            if (error) throw error;

            // Add to dropdown and select it
            const sel = document.getElementById('addModule');
            const newOpt = document.createElement('option');
            newOpt.value = data.module_id;
            newOpt.textContent = data.module_name;
            sel.insertBefore(newOpt, sel.querySelector('option[value="__new__"]'));
            sel.value = data.module_id;

            // Hide box and trigger change
            document.getElementById('newModuleBox').classList.remove('active');
            document.getElementById('newModuleName').value = '';
            document.getElementById('newModuleNumber').value = '';
            sel.dispatchEvent(new Event('change'));

            showMessage('addMessage', 'Module created!', 'success');
        } catch (error) {
            showMessage('addMessage', 'Error: ' + error.message, 'error');
        } finally {
            hideGlobalLoading();
        }
    }

    async function createNewClass() {
        const name = document.getElementById('newClassName').value.trim();
        const num = document.getElementById('newClassNumber').value;
        if (!name || !num || !formState.moduleId) {
            showMessage('addMessage', 'Please enter all class details', 'error');
            return;
        }

        showGlobalLoading('Creating class...');
        try {
            const { data, error } = await supabase
                .from('classes')
                .insert({
                    class_name: name,
                    class_number: parseInt(num),
                    module_id: formState.moduleId,
                    material_type: 'Slide Deck'
                })
                .select()
                .single();

            if (error) throw error;

            // Add to dropdown and select it
            const sel = document.getElementById('addClass');
            const newOpt = document.createElement('option');
            newOpt.value = data.class_id;
            newOpt.textContent = data.class_name;
            sel.insertBefore(newOpt, sel.querySelector('option[value="__new__"]'));
            sel.value = data.class_id;

            // Hide box and trigger change
            document.getElementById('newClassBox').classList.remove('active');
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassNumber').value = '';
            sel.dispatchEvent(new Event('change'));

            showMessage('addMessage', 'Class created!', 'success');
        } catch (error) {
            showMessage('addMessage', 'Error: ' + error.message, 'error');
        } finally {
            hideGlobalLoading();
        }
    }

    // VIEW & SEARCH
    async function loadAllData() {
        try {
            const { data, error } = await supabase
                .from('content_versions')
                .select(`
                    *,
                    classes (
                        class_id,
                        class_name,
                        class_number,
                        module_id,
                        modules (
                            module_id,
                            module_name,
                            module_number,
                            programme_id,
                            programmes (
                                programme_id,
                                programme_name
                            )
                        )
                    ),
                    client_pathways (
                        pathway_id,
                        programme_id,
                        cohort_name,
                        programmes (
                            programme_id,
                            programme_name
                        ),
                        clients (
                            client_id,
                            client_name
                        )
                    )
                `)
                .order('created_at', { ascending: false });

            if (error) throw error;
            allData = data || [];
            console.log('Loaded data:', allData);
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    document.getElementById('filterClient').addEventListener('change', async (e) => {
        const clientId = e.target.value;
        currentFilters.client = clientId || null;
        
        const progSel = document.getElementById('filterProgramme');
        const modSel = document.getElementById('filterModule');

        if (!clientId) {
            progSel.disabled = true;
            progSel.innerHTML = '<option value="">Select client first</option>';
            modSel.disabled = true;
            modSel.innerHTML = '<option value="">Select programme first</option>';
            return;
        }

        const { data } = await supabase
            .from('client_pathways')
            .select('programme_id, programmes(programme_id, programme_name)')
            .eq('client_id', clientId);

        progSel.disabled = false;
        progSel.innerHTML = '<option value="">All Programmes</option>';
        
        const uniqueProgs = [...new Map(data?.map(item => 
            [item.programmes?.programme_id, item.programmes]
        ).filter(([k, v]) => v)).values()];

        uniqueProgs.forEach(p => {
            progSel.innerHTML += `<option value="${p.programme_id}">${p.programme_name}</option>`;
        });

        modSel.disabled = true;
        modSel.innerHTML = '<option value="">Select programme first</option>';
    });

    document.getElementById('filterProgramme').addEventListener('change', async (e) => {
        const programmeId = e.target.value;
        currentFilters.programme = programmeId || null;
        
        const modSel = document.getElementById('filterModule');

        if (!programmeId) {
            modSel.disabled = true;
            modSel.innerHTML = '<option value="">Select programme first</option>';
            return;
        }

        const { data } = await supabase
            .from('modules')
            .select('*')
            .eq('programme_id', programmeId)
            .order('module_number');

        modSel.disabled = false;
        modSel.innerHTML = '<option value="">All Modules</option>';
        
        data?.forEach(m => {
            modSel.innerHTML += `<option value="${m.module_id}">${m.module_name}</option>`;
        });
    });

    document.getElementById('filterModule').addEventListener('change', (e) => {
        currentFilters.module = e.target.value || null;
    });

    // Quick search filters (independent)
    document.getElementById('quickSearchProgramme').addEventListener('change', (e) => {
        currentFilters.quickProgramme = e.target.value || null;
    });

    document.getElementById('quickSearchModule').addEventListener('change', (e) => {
        currentFilters.quickModule = e.target.value || null;
    });

    document.getElementById('filterStatus').addEventListener('change', (e) => {
        currentFilters.status = e.target.value || null;
    });

    document.getElementById('filterReadiness').addEventListener('change', (e) => {
        currentFilters.readiness = e.target.value || null;
    });

    function applyFilters() {
        console.log('Initial data:', allData);
        let filtered = [...allData];

        // Check which filter mode is active
        const drillDownActive = document.getElementById('drillDownFilters').classList.contains('active');
        const quickSearchActive = document.getElementById('quickSearchFilters').classList.contains('active');

        if (drillDownActive) {
            // Use only drill-down filters
            if (currentFilters.client) {
                filtered = filtered.filter(item => {
                    const matches = item.client_pathways?.clients?.client_id == currentFilters.client;
                    console.log(`Client filter (${currentFilters.client}):`, item.client_pathways?.clients?.client_id, matches);
                    return matches;
                });
            }

            if (currentFilters.programme) {
                filtered = filtered.filter(item => {
                    const matches = item.client_pathways?.programme_id == currentFilters.programme;
                    console.log(`Programme filter (${currentFilters.programme}):`, item.client_pathways?.programme_id, matches);
                    return matches;
                });
            }

            if (currentFilters.module) {
                filtered = filtered.filter(item => {
                    const matches = item.classes?.module_id == currentFilters.module;
                    console.log(`Module filter (${currentFilters.module}):`, item.classes?.module_id, matches);
                    return matches;
                });
            }
        } else if (quickSearchActive) {
            // Use only quick search filters
            if (currentFilters.quickProgramme) {
                filtered = filtered.filter(item => {
                    const pathwayMatch = item.client_pathways?.programme_id == currentFilters.quickProgramme;
                    const classMatch = item.classes?.modules?.programme_id == currentFilters.quickProgramme;
                    const matches = pathwayMatch || classMatch;
                    console.log(`Quick Programme filter (${currentFilters.quickProgramme}):`, matches);
                    return matches;
                });
            }

            if (currentFilters.quickModule) {
                filtered = filtered.filter(item => {
                    const matches = item.classes?.module_id == currentFilters.quickModule;
                    console.log(`Quick Module filter (${currentFilters.quickModule}):`, matches);
                    return matches;
                });
            }

            if (currentFilters.status) {
                filtered = filtered.filter(item => {
                    const matches = item.status === currentFilters.status;
                    console.log(`Status filter (${currentFilters.status}):`, item.status, matches);
                    return matches;
                });
            }

            if (currentFilters.readiness) {
                filtered = filtered.filter(item => {
                    const matches = item.readiness_level === currentFilters.readiness;
                    console.log(`Readiness filter (${currentFilters.readiness}):`, item.readiness_level, matches);
                    return matches;
                });
            }
        }

        console.log('Filtered results:', filtered);
        
        // Show readiness warning if applicable
        showReadinessWarning(filtered);
        
        displayResults(filtered);
    }

    function showReadinessWarning(data) {
        const warningBox = document.getElementById('readinessWarning');
        
        if (!data || data.length === 0) {
            warningBox.style.display = 'none';
            return;
        }

        // Count readiness levels
        const notStarted = data.filter(item => item.readiness_level === 'Not Started').length;
        const baselineOnly = data.filter(item => item.readiness_level === 'Baseline Only').length;
        const inDev = data.filter(item => item.readiness_level === 'In Development').length;
        const ready = data.filter(item => item.readiness_level === 'Ready for Delivery').length;
        const approved = data.filter(item => item.readiness_level === 'Client Approved').length;

        // Only show warning if there are non-ready items
        if (notStarted > 0 || baselineOnly > 0 || inDev > 0) {
            let warningText = `<strong>⚠️ Content Readiness Alert:</strong><br>`;
            
            if (notStarted > 0) warningText += `🔴 <strong>${notStarted}</strong> Not Started | `;
            if (baselineOnly > 0) warningText += `🟡 <strong>${baselineOnly}</strong> Baseline Only | `;
            if (inDev > 0) warningText += `🟡 <strong>${inDev}</strong> In Development | `;
            
            warningText = warningText.slice(0, -3); // Remove last " | "
            warningText += `<br><br>`;
            
            if (ready > 0) warningText += `✅ <strong>${ready}</strong> Ready for Delivery | `;
            if (approved > 0) warningText += `⭐ <strong>${approved}</strong> Client Approved | `;
            
            if (ready > 0 || approved > 0) {
                warningText = warningText.slice(0, -3);
            } else {
                warningText += `<br>❗ <strong>No items are ready for client delivery.</strong>`;
            }

            warningBox.innerHTML = warningText;
            warningBox.style.display = 'block';
        } else {
            warningBox.style.display = 'none';
        }
    }

    function clearFilters() {
        // Clear cascading filters
        document.getElementById('filterClient').value = '';
        document.getElementById('filterProgramme').value = '';
        document.getElementById('filterProgramme').disabled = true;
        document.getElementById('filterModule').value = '';
        document.getElementById('filterModule').disabled = true;
        
        // Clear quick search filters
        document.getElementById('quickSearchProgramme').value = '';
        document.getElementById('quickSearchModule').value = '';
        
        // Clear status and readiness
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterReadiness').value = '';
        
        // Reset filter state
        currentFilters = { 
            client: null, 
            programme: null, 
            module: null, 
            status: null, 
            readiness: null,
            quickProgramme: null,
            quickModule: null
        };
        
        // Hide warning and reset display
        document.getElementById('readinessWarning').style.display = 'none';
        document.getElementById('dataContainer').innerHTML = '<p class="loading">Select filters and click "Apply Filters"</p>';
        document.getElementById('resultsCount').textContent = '';
    }

    function displayResults(data) {
        const container = document.getElementById('dataContainer');
        document.getElementById('resultsCount').textContent = `${data.length} results found`;

        if (!data || data.length === 0) {
            container.innerHTML = '<p class="loading">No results found</p>';
            return;
        }

        const html = `
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width: 100px;">Client</th>
                            <th style="min-width: 140px;">Programme</th>
                            <th style="min-width: 60px; text-align: center;">🚦</th>
                            <th style="min-width: 140px;">Module</th>
                            <th style="min-width: 140px;">Class</th>
                            <th style="min-width: 100px;">Status</th>
                            <th style="min-width: 120px;">Version Code</th>
                            <th style="min-width: 80px;">Ver</th>
                            <th style="min-width: 100px;">Feedback</th>
                            <th style="min-width: 130px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => {
                            // Determine readiness icon and tooltip
                            let readinessIcon = '🟢';
                            let readinessText = 'Ready for Delivery';
                            if (item.readiness_level === 'Not Started') {
                                readinessIcon = '🔴';
                                readinessText = 'Not Started';
                            } else if (item.readiness_level === 'Baseline Only') {
                                readinessIcon = '🟡';
                                readinessText = 'Baseline Only';
                            } else if (item.readiness_level === 'In Development') {
                                readinessIcon = '🟡';
                                readinessText = 'In Development';
                            } else if (item.readiness_level === 'Client Approved') {
                                readinessIcon = '⭐';
                                readinessText = 'Client Approved';
                            }
                            
                            return `
                            <tr>
                                <td>${item.client_pathways?.clients?.client_name || '-'}</td>
                                <td>${item.classes?.modules?.programmes?.programme_name || '-'}</td>
                                <td style="text-align: center; font-size: 1.3rem;" title="${readinessText}">${readinessIcon}</td>
                                <td>${item.classes?.modules?.module_name || '-'}</td>
                                <td>${item.classes?.class_name || '-'}</td>
                                <td>${getStatusBadge(item.status)}</td>
                                <td><strong>${item.version_code}</strong></td>
                                <td>${item.version_number || '-'}</td>
                                <td style="font-size: 0.9rem;">${item.client_feedback || '-'}</td>
                                <td>
                                    <button class="action-btn edit-btn" onclick="openEditModal(${item.version_id})">
                                        Edit
                                    </button>
                                    <button class="action-btn" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);" onclick="viewHistory(${item.version_id})">
                                        History
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteVersion(${item.version_id})">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = html;
    }

    function getStatusBadge(status) {
        const className = (status || 'open').toLowerCase().replace(/\s+/g, '-');
        return `<span class="status-badge status-${className}">${status || 'Open'}</span>`;
    }

    async function openEditModal(versionId) {
        const version = allData.find(v => v.version_id === versionId);
        if (!version) return;

        document.getElementById('editVersionId').value = version.version_id;
        document.getElementById('editVersionCode').value = version.version_code;
        
        // Store current version for auto-increment calculation
        const currentVersion = version.version_number || 'v1.0';
        document.getElementById('editVersionNumber').setAttribute('data-current-version', currentVersion);
        document.getElementById('editVersionNumber').value = currentVersion; // Show CURRENT version initially
        
        document.getElementById('editReadiness').value = version.readiness_level || 'Ready for Delivery';
        document.getElementById('editStatus').value = version.status || 'Open';
        document.getElementById('editFeedback').value = version.client_feedback || '';
        document.getElementById('editChangeSummary').value = '';
        document.getElementById('editSignificantChange').checked = false;
        document.getElementById('editDriveLink').value = version.drive_link || '';
        document.getElementById('editNotes').value = version.notes || '';
        
        document.getElementById('editModal').classList.add('active');
    }

    function updateVersionPreview() {
        const changelogField = document.getElementById('editChangeSummary');
        const versionNumberField = document.getElementById('editVersionNumber');
        const currentVersion = versionNumberField.getAttribute('data-current-version') || 'v1.0';
        
        // Only show new version if changelog has content
        if (!changelogField.value.trim()) {
            // No changelog = no version change
            versionNumberField.value = currentVersion;
            return;
        }
        
        const isSignificant = document.getElementById('editSignificantChange').checked;
        
        // Parse current version (e.g., "v1.2" -> major: 1, minor: 2)
        const match = currentVersion.match(/v?(\d+)\.(\d+)/);
        if (!match) {
            versionNumberField.value = 'v1.0';
            return;
        }
        
        let major = parseInt(match[1]);
        let minor = parseInt(match[2]);
        
        // Calculate new version
        if (isSignificant) {
            // Significant change: bump major version, reset minor to 0
            major += 1;
            minor = 0;
        } else {
            // Minor change: bump minor version
            minor += 1;
        }
        
        const newVersion = `v${major}.${minor}`;
        versionNumberField.value = newVersion;
    }

    function closeModal() {
        document.getElementById('editModal').classList.remove('active');
        document.getElementById('modalMessage').innerHTML = '';
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const versionId = document.getElementById('editVersionId').value;
        const changeSummary = document.getElementById('editChangeSummary').value.trim();
        const isSignificant = document.getElementById('editSignificantChange').checked;
        
        // Determine if version should increment
        // Only increment if there's a changelog entry (meaning actual content changed)
        let newVersionNumber = document.getElementById('editVersionNumber').getAttribute('data-current-version');
        
        if (changeSummary) {
            // Content changed - use the auto-calculated version
            newVersionNumber = document.getElementById('editVersionNumber').value;
        }
        // If no changelog, keep the current version (just metadata update like feedback/status)
        
        const updates = {
            version_number: newVersionNumber,
            readiness_level: document.getElementById('editReadiness').value,
            status: document.getElementById('editStatus').value,
            client_feedback: document.getElementById('editFeedback').value || null,
            change_summary: changeSummary || null,
            is_significant_change: isSignificant,
            drive_link: document.getElementById('editDriveLink').value || null,
            notes: document.getElementById('editNotes').value || null,
            updated_at: new Date().toISOString()
        };

        showGlobalLoading('Saving changes...');

        try {
            const { error } = await supabase
                .from('content_versions')
                .update(updates)
                .eq('version_id', versionId);

            if (error) throw error;

            // Insert changelog if there were content changes
            if (changeSummary) {
                const { error: logError } = await supabase.from('version_changelog').insert({
                    version_id: parseInt(versionId),
                    change_description: changeSummary,
                    is_significant: isSignificant,
                    changed_by: 'Dashboard User'
                });
                
                if (logError) {
                    console.error('Changelog insert failed:', logError);
                    alert('Warning: Changelog entry failed to save: ' + logError.message);
                }
            }
            
            document.getElementById('modalMessage').innerHTML = '<div class="message success">Updated successfully!</div>';

            setTimeout(() => {
                closeModal();
                loadAllData().then(() => applyFilters());
            }, 1500);

        } catch (error) {
            document.getElementById('modalMessage').innerHTML = 
                '<div class="message error">Error: ' + error.message + '</div>';
        } finally {
            hideGlobalLoading();
        }
    });

    async function deleteVersion(versionId) {
        if (!confirm('⚠️ Are you sure you want to delete this version?\n\nThis action cannot be undone.')) {
            return;
        }

        showGlobalLoading('Deleting version...');

        try {
            const { error } = await supabase
                .from('content_versions')
                .delete()
                .eq('version_id', versionId);

            if (error) throw error;

            await loadAllData();
            applyFilters();
            
            alert('Version deleted successfully!');

        } catch (error) {
            alert('Error deleting version: ' + error.message);
        } finally {
            hideGlobalLoading();
        }
    }

    async function viewHistory(versionId) {
        const version = allData.find(v => v.version_id === versionId);
        if (!version) return;

        document.getElementById('historyModal').classList.add('active');
        document.getElementById('historyContent').innerHTML = '<p style="text-align: center; color: #64748b;">Loading history...</p>';

        try {
            // Fetch changelog for this version
            const { data, error } = await supabase
                .from('version_changelog')
                .select('*')
                .eq('version_id', versionId)
                .order('changed_at', { ascending: false });

            if (error) throw error;

            // Build the history display
            let html = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <strong style="color: #64748b; font-size: 0.85rem;">CLIENT</strong>
                            <p style="margin-top: 5px;">${version.client_pathways?.clients?.client_name || '-'}</p>
                        </div>
                        <div>
                            <strong style="color: #64748b; font-size: 0.85rem;">PROGRAMME</strong>
                            <p style="margin-top: 5px;">${version.classes?.modules?.programmes?.programme_name || '-'}</p>
                        </div>
                        <div>
                            <strong style="color: #64748b; font-size: 0.85rem;">MODULE</strong>
                            <p style="margin-top: 5px;">${version.classes?.modules?.module_name || '-'}</p>
                        </div>
                        <div>
                            <strong style="color: #64748b; font-size: 0.85rem;">CLASS</strong>
                            <p style="margin-top: 5px;">${version.classes?.class_name || '-'}</p>
                        </div>
                        <div>
                            <strong style="color: #64748b; font-size: 0.85rem;">VERSION CODE</strong>
                            <p style="margin-top: 5px;"><strong>${version.version_code}</strong></p>
                        </div>
                        <div>
                            <strong style="color: #64748b; font-size: 0.85rem;">CURRENT VERSION</strong>
                            <p style="margin-top: 5px;"><strong>${version.version_number}</strong></p>
                        </div>
                    </div>
                </div>
                <h4 style="margin-bottom: 15px; color: #4a5568;">📝 Change History</h4>
            `;

            if (!data || data.length === 0) {
                html += '<p style="text-align: center; color: #94a3b8; padding: 30px;">No changes recorded yet</p>';
            } else {
                html += '<div style="display: flex; flex-direction: column; gap: 15px;">';
                data.forEach(change => {
                    const date = new Date(change.changed_at);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const badge = change.is_significant 
                        ? '<span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">🚨 MAJOR</span>'
                        : '<span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">📌 MINOR</span>';

                    html += `
                        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 5px;">
                                        ${formattedDate} • ${change.changed_by || 'Unknown'}
                                    </div>
                                    ${badge}
                                </div>
                            </div>
                            <p style="color: #1e293b; line-height: 1.6; margin-top: 10px;">${change.change_description}</p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            document.getElementById('historyContent').innerHTML = html;

        } catch (error) {
            document.getElementById('historyContent').innerHTML = 
                `<p style="text-align: center; color: #ef4444; padding: 30px;">Error loading history: ${error.message}</p>`;
        }
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').classList.remove('active');
    }

    window.addEventListener('load', () => {
        loadDashboard();
    });
</script>
</body>
</html>
